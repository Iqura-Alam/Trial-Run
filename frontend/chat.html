<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Buyer-Seller Chat</title>
<style>
  #chat {
    height: 300px;
    border: 1px solid #ccc;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
  }
  #chat div {
    margin-bottom: 8px;
  }
  img {
    max-width: 150px;
    display: block;
  }
</style>
</head>
<body>

<div id="chat"></div>

<input type="text" id="msgInput" placeholder="Type your message" />
<button onclick="sendMessage()">Send</button>

<br /><br />

<input type="file" id="imgInput" />
<button onclick="sendImage()">Send Image</button>

<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script>
  // These should come from your app logic or auth/session
  const listingId = 'abc123';
  const buyerId = 'buyer001';
  const sellerId = 'seller001';

  // Construct unique roomId for buyer-seller-chat
  const roomId = `listing-${listingId}-buyer-${buyerId}-seller-${sellerId}`;

  // Set sender based on logged-in user
  let sender = 'buyer'; // or 'seller'

  const socket = io('http://localhost:3000');

  socket.emit('joinRoom', { roomId });

  const chatDiv = document.getElementById('chat');

  socket.on('chatMessage', ({ sender, message }) => {
    const el = document.createElement('div');
    el.innerHTML = `<strong>${sender}:</strong> ${message}`;
    chatDiv.appendChild(el);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });

  socket.on('chatImage', ({ sender, imageUrl }) => {
    const el = document.createElement('div');
    el.innerHTML = `<strong>${sender}:</strong><br><img src="${imageUrl}" />`;
    chatDiv.appendChild(el);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });

  function sendMessage() {
    const messageInput = document.getElementById('msgInput');
    const message = messageInput.value.trim();
    if (!message) return;

    socket.emit('chatMessage', { roomId, sender, message });
    messageInput.value = '';
  }

  async function sendImage() {
    const fileInput = document.getElementById('imgInput');
    const file = fileInput.files[0];
    if (!file) return alert('Please select an image first.');

    const formData = new FormData();
    formData.append('image', file);

    try {
      const res = await fetch('http://localhost:3000/upload', {
        method: 'POST',
        body: formData,
      });

      const data = await res.json();
      socket.emit('chatImage', { roomId, sender, imageUrl: data.imageUrl });
      fileInput.value = ''; // Clear input
    } catch (err) {
      alert('Image upload failed.');
      console.error(err);
    }
  }
</script>

</body>
</html>
